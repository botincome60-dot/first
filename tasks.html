<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সহজ ইনকাম - টাস্ক</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .task-completed {
            background: #f0f9ff !important;
            border-color: #bae6fd !important;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 pb-16">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">লোড হচ্ছে...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 fade-in">
        <!-- হেডার -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-4 text-white mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-lg">টাস্ক করুন</h2>
                    <p class="text-white/80 text-sm">আয় করুন সহজ টাস্ক করে</p>
                </div>
                <i class="fas fa-tasks text-2xl"></i>
            </div>
        </div>

        <!-- ওয়াচ এড সেকশন -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-lg">এড দেখুন</h3>
                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm font-semibold">
                    <span id="adsRemaining">০</span>/১০ এড বাকি
                </span>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-3">
                <div class="text-center mb-3">
                    <i class="fas fa-play-circle text-blue-500 text-4xl mb-2"></i>
                    <h4 class="font-bold text-lg">রিওয়ার্ডেড এড</h4>
                    <p class="text-gray-600">প্রতি এড দেখে পাবেন ৩০.০০ টাকা</p>
                </div>
                
                <a href="watch-ads.html" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-lg font-bold text-center block hover:from-blue-600 hover:to-blue-700 transition-colors">
                    এড দেখুন
                </a>
            </div>
            
            <p class="text-gray-500 text-sm text-center">
                প্রতি ঘন্টায় ১০টি এড দেখতে পারবেন
            </p>
        </div>

        <!-- বোনাস টাস্কস -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="font-bold text-lg mb-3">বোনাস টাস্কস</h3>
            
            <div class="space-y-3">
                <!-- টাস্ক ১ - Telegram Channel -->
                <div class="border border-gray-200 rounded-xl p-3" id="telegramTask">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h4 class="font-semibold">টেলিগ্রাম চ্যানেল জয়েন করুন</h4>
                            <p class="text-green-600 text-sm font-semibold">৫০ টাকা বোনাস</p>
                        </div>
                        <i class="fas fa-telegram text-blue-400 text-xl"></i>
                    </div>
                    <button onclick="completeTelegramTask()" id="telegramBtn" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                        ক্লেইম করুন
                    </button>
                </div>
                
                <!-- টাস্ক ২ - YouTube Channel -->
                <div class="border border-gray-200 rounded-xl p-3" id="youtubeTask">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h4 class="font-semibold">ইউটিউব চ্যানেল সাবস্ক্রাইব</h4>
                            <p class="text-green-600 text-sm font-semibold">৫০ টাকা বোনাস</p>
                        </div>
                        <i class="fab fa-youtube text-red-500 text-xl"></i>
                    </div>
                    <button onclick="completeYoutubeTask()" id="youtubeBtn" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                        ক্লেইম করুন
                    </button>
                </div>
                
                <!-- টাস্ক ৩ - Video Task -->
                <div class="border border-gray-200 rounded-xl p-3" id="videoTask">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h4 class="font-semibold">কাজের ভিডিও দেখুন</h4>
                            <p class="text-green-600 text-sm font-semibold">১০০ টাকা বোনাস</p>
                        </div>
                        <i class="fas fa-video text-purple-500 text-xl"></i>
                    </div>
                    <button onclick="completeVideoTask()" id="videoBtn" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                        ক্লেইম করুন
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- বটম নেভিগেশন -->
    <div class="bottom-nav">
        <div class="grid grid-cols-4 gap-1 p-2">
            <a href="index.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-home mb-1"></i>
                <span class="text-xs">হোম</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center p-2 text-blue-600">
                <i class="fas fa-tasks mb-1"></i>
                <span class="text-xs">টাস্ক</span>
            </a>
            <a href="support.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-headset mb-1"></i>
                <span class="text-xs">সাপোর্ট</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-user mb-1"></i>
                <span class="text-xs">প্রোফাইল</span>
            </a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="app.js"></script>

    <script>
        // Firebase-based task management
        let db;
        let userData = null;

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp({
                    apiKey: "AIzaSyABdp9WK7eGLwE5nY19jp-nlDlyTuTyMR0",
                    authDomain: "sohojincome-36f1f.firebaseapp.com",
                    projectId: "sohojincome-36f1f",
                    storageBucket: "sohojincome-36f1f.firebasestorage.app",
                    messagingSenderId: "398153090805",
                    appId: "1:398153090805:web:fc8d68130afbc2239be7bc",
                    measurementId: "G-VZ47961SJV"
                });
            }
            db = firebase.firestore();
            console.log("✅ Firebase initialized successfully");
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
        }

        async function initTasksPage() {
            userData = getUserData();
            if (userData) {
                const remaining = 10 - userData.today_ads;
                document.getElementById('adsRemaining').textContent = remaining > 0 ? remaining : 0;
                
                // Load task states from Firebase
                await loadTaskStatesFromFirebase();
            }
            hideLoading();
        }

        // Load task states from Firebase
        async function loadTaskStatesFromFirebase() {
            if (!userData || !db) return;
            
            try {
                const taskDoc = await db.collection('user_tasks').doc(userData.id).get();
                
                if (taskDoc.exists) {
                    const taskData = taskDoc.data();
                    updateTaskButtons(taskData);
                } else {
                    // Create initial task document
                    await db.collection('user_tasks').doc(userData.id).set({
                        userId: userData.id,
                        telegram_completed: false,
                        youtube_completed: false,
                        video_completed: false,
                        last_updated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateTaskButtons({
                        telegram_completed: false,
                        youtube_completed: false,
                        video_completed: false
                    });
                }
            } catch (error) {
                console.error('❌ Error loading task states:', error);
            }
        }

        // Update task buttons based on Firebase data
        function updateTaskButtons(taskData) {
            // Telegram Task
            if (taskData.telegram_completed) {
                document.getElementById('telegramBtn').innerHTML = '✅ ক্লেইমড';
                document.getElementById('telegramBtn').classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('telegramBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('telegramBtn').disabled = true;
                document.getElementById('telegramTask').classList.add('task-completed');
            }

            // YouTube Task
            if (taskData.youtube_completed) {
                document.getElementById('youtubeBtn').innerHTML = '✅ ক্লেইমড';
                document.getElementById('youtubeBtn').classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('youtubeBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('youtubeBtn').disabled = true;
                document.getElementById('youtubeTask').classList.add('task-completed');
            }

            // Video Task
            if (taskData.video_completed) {
                document.getElementById('videoBtn').innerHTML = '✅ ক্লেইমড';
                document.getElementById('videoBtn').classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('videoBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('videoBtn').disabled = true;
                document.getElementById('videoTask').classList.add('task-completed');
            }
        }

        // Complete Telegram Task
        async function completeTelegramTask() {
            if (!userData || !db) {
                showNotification('ডেটা লোড হয়নি। রিফ্রেশ করুন।', 'error');
                return;
            }

            // Check if already completed
            const taskDoc = await db.collection('user_tasks').doc(userData.id).get();
            if (taskDoc.exists && taskDoc.data().telegram_completed) {
                showNotification('আপনি ইতিমধ্যে এই টাস্কটি কমপ্লিট করেছেন!', 'info');
                return;
            }

            const telegramLink = "https://t.me/sohojincome629";
            window.open(telegramLink, '_blank');
            
            // Update task completion in Firebase
            await db.collection('user_tasks').doc(userData.id).set({
                telegram_completed: true,
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            await addTaskBonus(50, "টেলিগ্রাম চ্যানেল জয়েন");
            await loadTaskStatesFromFirebase(); // Reload task states
            
            showNotification("টেলিগ্রাম চ্যানেলে জয়েন করুন এবং ৫০ টাকা বোনাস পান!", "info");
        }

        // Complete YouTube Task
        async function completeYoutubeTask() {
            if (!userData || !db) {
                showNotification('ডেটা লোড হয়নি। রিফ্রেশ করুন।', 'error');
                return;
            }

            // Check if already completed
            const taskDoc = await db.collection('user_tasks').doc(userData.id).get();
            if (taskDoc.exists && taskDoc.data().youtube_completed) {
                showNotification('আপনি ইতিমধ্যে এই টাস্কটি কমপ্লিট করেছেন!', 'info');
                return;
            }

            const youtubeLink = "https://www.youtube.com/@easyincome-x7u";
            window.open(youtubeLink, '_blank');
            
            // Update task completion in Firebase
            await db.collection('user_tasks').doc(userData.id).set({
                youtube_completed: true,
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            await addTaskBonus(50, "ইউটিউব চ্যানেল সাবস্ক্রাইব");
            await loadTaskStatesFromFirebase(); // Reload task states
            
            showNotification("ইউটিউব চ্যানেল সাবস্ক্রাইব করুন এবং ৫০ টাকা বোনাস পান!", "info");
        }

        // Complete Video Task
        async function completeVideoTask() {
            if (!userData || !db) {
                showNotification('ডেটা লোড হয়নি। রিফ্রেশ করুন।', 'error');
                return;
            }

            // Check if already completed
            const taskDoc = await db.collection('user_tasks').doc(userData.id).get();
            if (taskDoc.exists && taskDoc.data().video_completed) {
                showNotification('আপনি ইতিমধ্যে এই টাস্কটি কমপ্লিট করেছেন!', 'info');
                return;
            }

            const videoLink = "https://example.com/sohojincome_video";
            window.open(videoLink, '_blank');
            
            // Update task completion in Firebase
            await db.collection('user_tasks').doc(userData.id).set({
                video_completed: true,
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            await addTaskBonus(100, "কাজের ভিডিও দেখা");
            await loadTaskStatesFromFirebase(); // Reload task states
            
            showNotification("ভিডিওটি দেখুন এবং ১০০ টাকা বোনাস পান!", "info");
        }

        async function addTaskBonus(amount, taskName) {
            const user = getUserData();
            if (user) {
                await updateUserData({ 
                    balance: user.balance + amount,
                    total_income: user.total_income + amount
                });
                
                setTimeout(() => {
                    showNotification(`সফল! ${amount} টাকা বোনাস যোগ হয়েছে (${taskName})`, "success");
                }, 1000);
            }
        }

        function showNotification(message, type = 'info') {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.showPopup({
                    title: type === 'success' ? 'সফল!' : 'মেসেজ',
                    message: message,
                    buttons: [{ type: 'close' }]
                });
            } else {
                alert(message);
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Admin function to reset tasks for all users (for testing)
        async function resetAllTasksForUser() {
            if (!userData || !db) return;
            
            if (confirm('আপনি কি সব টাস্ক রিসেট করতে চান?')) {
                try {
                    await db.collection('user_tasks').doc(userData.id).set({
                        telegram_completed: false,
                        youtube_completed: false,
                        video_completed: false,
                        last_updated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showNotification('সব টাস্ক রিসেট করা হয়েছে!', 'success');
                    await loadTaskStatesFromFirebase();
                } catch (error) {
                    console.error('Error resetting tasks:', error);
                    showNotification('টাস্ক রিসেট করতে সমস্যা হয়েছে!', 'error');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTasksPage, 1000);
        });

        // For testing - add this to browser console
        window.resetAllTasksForUser = resetAllTasksForUser;
    </script>
</body>
</html>