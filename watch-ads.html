<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡¶π‡¶ú ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ - ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding-bottom: 20px;
        }
        .ad-loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 fade-in">
        <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-4 text-white mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-lg">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h2>
                    <p class="text-white/80 text-sm">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
                <i class="fas fa-play-circle text-2xl"></i>
            </div>
        </div>

        <!-- ‡¶è‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞ -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4 text-center">
            <div class="mb-4">
                <h3 class="font-bold text-lg mb-2">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶è‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
                <div class="text-4xl font-bold text-blue-600" id="adsCounter">‡ß¶/‡ß®‡ß¶</div>
                <p class="text-gray-500 text-sm mt-2" id="resetTimer">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ßü ‡ß®‡ß¶‡¶ü‡¶ø ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
            </div>
            
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                <div id="progressBar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶è‡¶∞‡ßü‡¶æ -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
            <div class="text-center mb-4">
                <i class="fas fa-ad text-yellow-500 text-4xl mb-3"></i>
                <h3 class="font-bold text-lg">‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶° ‡¶è‡¶°</h3>
                <p class="text-gray-600">‡¶è‡¶á ‡¶è‡¶°‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶® <span class="font-bold text-green-600">‡ß©‡ß¶.‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</span></p>
            </div>
            
            <!-- ‡¶è‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶∞‡ßü‡¶æ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center mb-4">
                <div id="adContent">
                    <h4 class="font-bold text-lg mb-2">üé¨ ‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶° ‡¶è‡¶°</h4>
                    <p class="text-gray-600 mb-3">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                    
                    <div class="bg-white p-4 rounded-lg border border-blue-300">
                        <i class="fas fa-ad text-blue-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-500 mb-3">‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        <p class="text-xs text-gray-400" id="adStatus">‡¶è‡¶° ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§</p>
                    </div>
                </div>
            </div>
            
            <!-- ‡¶¨‡¶æ‡¶ü‡¶® -->
            <button onclick="showAd()" id="watchAdBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg mb-3 hover:from-green-600 hover:to-green-700 transition-colors">
                <i class="fas fa-play mr-2"></i>
                ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
            </button>
            
            <div class="text-center">
                <p class="text-gray-500 text-sm" id="rewardStatus">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá</p>
            </div>
        </div>

        <!-- ‡¶§‡¶•‡ßç‡¶Ø -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-500 mt-1 mr-2"></i>
                <div>
                    <h4 class="font-semibold text-yellow-700">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <p class="text-yellow-600 text-sm">‚Ä¢ ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞ ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ö‡¶ü‡ßã ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá</p>
                    <p class="text-yellow-600 text-sm">‚Ä¢ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ßü ‡ß®‡ß¶‡¶ü‡¶ø ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
                    <p class="text-yellow-600 text-sm">‚Ä¢ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶è‡¶° ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá</p>
                    <p class="text-yellow-600 text-sm">‚Ä¢ ‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡¶ø‡¶ú‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</p>
                </div>
            </div>
        </div>

        <!-- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® -->
        <a href="tasks.html" class="w-full bg-gray-500 text-white py-3 rounded-xl font-bold text-center block mt-4 hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
        </a>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app-supabase.js"></script>

    <script>
        // ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
        const AD_LINKS = [
            "https://ferocitysuperintend.com/q3gtdwtif0?key=8fab9c833a59630b50874801fba88f73",
            "https://ferocitysuperintend.com/wzvdzr4ka?key=7a422407e8fedbc108da1c1da906f0a9",
            "https://adexora.my.id/dl/uDjmlB4uoO",
            "https://otieu.com/4/9809044",
            "https://otieu.com/4/10095617",
            "https://otieu.com/4/9345167",
            "https://otieu.com/4/9569635",
            "https://otieu.com/4/10155431",
            "https://adexora.my.id/dl/FroDWns7Gj",
            "https://otieu.com/4/9550427",
            "https://ferocitysuperintend.com/img7n81xh8?key=60effca0c228e66afd204784027d8b16"
        ];

        let isAdLoading = false;
        let userAdsData = {
            today_ads: 0,
            last_ad_reset: null
        };
        let adWindow = null; // ‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏

        function initAdsPage() {
            loadAdsData();
            updateResetTimer();
            hideLoading();
        }

        function loadAdsData() {
            const user = getUserData();
            if (user) {
                // Check if reset is needed
                checkAndResetAdsCounter(user);
                
                userAdsData.today_ads = user.today_ads || 0;
                userAdsData.last_ad_reset = user.last_ad_reset || user.join_date;
                updateCounter();
            } else {
                console.log("User data not found");
                hideLoading();
            }
        }

        async function checkAndResetAdsCounter(user) {
            try {
                const lastReset = new Date(user.last_ad_reset || user.join_date);
                const now = new Date();
                const hoursDiff = (now - lastReset) / (1000 * 60 * 60);
                
                // If 1 hour has passed, reset counter
                if (hoursDiff >= 1) {
                    console.log("Resetting ads counter, time passed:", hoursDiff, "hours");
                    
                    await updateUserData({ 
                        today_ads: 0,
                        last_ad_reset: now.toISOString()
                    });
                    
                    // Reload user data
                    const updatedUser = getUserData();
                    if (updatedUser) {
                        userAdsData.today_ads = 0;
                        userAdsData.last_ad_reset = now.toISOString();
                        updateCounter();
                    }
                }
            } catch (error) {
                console.error("Error resetting ads counter:", error);
            }
        }

        function updateCounter() {
            document.getElementById('adsCounter').textContent = `${userAdsData.today_ads}/‡ß®‡ß¶`;
            const progress = (userAdsData.today_ads / 20) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Check if user can watch more ads
            if (!canWatchMoreAds()) {
                document.getElementById('watchAdBtn').disabled = true;
                document.getElementById('watchAdBtn').classList.remove('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                document.getElementById('watchAdBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('watchAdBtn').innerHTML = '<i class="fas fa-clock mr-2"></i>‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑ - ' + getTimeUntilNextReset() + ' ‡¶™‡¶∞';
            } else {
                document.getElementById('watchAdBtn').disabled = false;
                document.getElementById('watchAdBtn').classList.remove('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('watchAdBtn').classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                document.getElementById('watchAdBtn').innerHTML = '<i class="fas fa-play mr-2"></i>‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
            }
        }

        function updateResetTimer() {
            const resetTimer = document.getElementById('resetTimer');
            const timeUntilReset = getTimeUntilNextReset();
            resetTimer.textContent = `‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ßü ‡ß®‡ß¶‡¶ü‡¶ø ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® (‡¶∞‡¶ø‡¶∏‡ßá‡¶ü: ${timeUntilReset})`;
        }

        function canWatchMoreAds() {
            if (!userAdsData.last_ad_reset) {
                return true;
            }
            
            const lastReset = new Date(userAdsData.last_ad_reset);
            const now = new Date();
            const hoursDiff = (now - lastReset) / (1000 * 60 * 60);
            
            console.log("Hours since last reset:", hoursDiff);
            
            // If 1 hour has passed, user can watch ads again
            if (hoursDiff >= 1) {
                return true;
            }
            
            // Check if user hasn't reached the hourly limit (now 20)
            return userAdsData.today_ads < 20;
        }

        function getTimeUntilNextReset() {
            if (!userAdsData.last_ad_reset) {
                return '‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡¶®‡¶ø';
            }
            
            const lastReset = new Date(userAdsData.last_ad_reset);
            const now = new Date();
            const nextReset = new Date(lastReset.getTime() + (60 * 60 * 1000)); // 1 hour later
            const timeDiff = nextReset - now;
            
            if (timeDiff <= 0) {
                return '‡¶è‡¶ñ‡¶®‡¶á ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá';
            }
            
            const minutes = Math.ceil(timeDiff / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours > 0) {
                return `${hours} ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ${remainingMinutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü`;
            } else {
                return `${minutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü`;
            }
        }

        async function showAd() {
            const user = getUserData();
            if (!user) {
                alert('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            if (!canWatchMoreAds()) {
                alert(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶° ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑! ${getTimeUntilNextReset()} ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
                return;
            }

            if (isAdLoading) {
                return;
            }

            isAdLoading = true;
            const watchBtn = document.getElementById('watchAdBtn');
            watchBtn.disabled = true;
            watchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡¶è‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            watchBtn.classList.add('ad-loading');
            document.getElementById('adStatus').textContent = '‡¶è‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('adStatus').className = 'text-xs text-yellow-600';

            try {
                // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
                if (adWindow && !adWindow.closed) {
                    adWindow.close();
                }
                
                await showAdLink();
                
            } catch (error) {
                console.error('‚ùå Ad error:', error);
                document.getElementById('adStatus').textContent = '‡¶è‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ - ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
                document.getElementById('adStatus').className = 'text-xs text-red-600';
                
                alert('‡¶è‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                
                resetAdButton();
                isAdLoading = false;
            }
        }

        // Random ad link function
        function showAdLink() {
            return new Promise((resolve) => {
                document.getElementById('adStatus').textContent = '‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
                document.getElementById('adStatus').className = 'text-xs text-blue-600';
                
                const watchBtn = document.getElementById('watchAdBtn');
                watchBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>‡¶è‡¶° ‡¶ö‡¶≤‡¶õ‡ßá...';
                
                // Randomly select a link
                const randomIndex = Math.floor(Math.random() * AD_LINKS.length);
                const selectedLink = AD_LINKS[randomIndex];
                
                console.log(`Selected ad index: ${randomIndex}, Link: ${selectedLink}`);
                
                // Open the link in new tab - WITHOUT auto-closing
                adWindow = window.open(selectedLink, '_blank', 'width=800,height=600');
                
                if (!adWindow) {
                    alert('‡¶™‡¶™‡¶Ü‡¶™ ‡¶¨‡ßç‡¶≤‡¶ï‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡ßá‡¶¨‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶â ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§');
                    resetAdButton();
                    isAdLoading = false;
                    resolve();
                    return;
                }
                
                // Focus back to main window after a short delay
                setTimeout(() => {
                    if (window.focus) window.focus();
                }, 500);
                
                // Simulate ad watching for 10 seconds only
                // ‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶¨‡ßá
                setTimeout(async () => {
                    try {
                        await rewardUserForAd();
                        
                        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßã ‡¶®‡¶æ - ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡¶ø‡¶ú‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶¨‡ßá
                        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶¨‡ßã ‡¶Ø‡ßá ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá
                        
                        document.getElementById('adStatus').textContent = '‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡ßç‡¶£! ‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶®‡¶ø‡¶ú‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®';
                        document.getElementById('adStatus').className = 'text-xs text-green-600';
                        
                    } finally {
                        resolve();
                    }
                }, 10000); // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°
            });
        }

        async function rewardUserForAd() {
            const user = getUserData();
            if (!user) return;
            
            try {
                // Check if we need to reset ads counter first
                await checkAndResetAdsCounter(user);
                
                // Get current user data again
                const currentUser = getUserData();
                if (!currentUser) return;
                
                let todayAds = currentUser.today_ads || 0;
                let lastAdReset = currentUser.last_ad_reset || currentUser.join_date;
                const lastResetTime = new Date(lastAdReset);
                const now = new Date();
                const hoursDiff = (now - lastResetTime) / (1000 * 60 * 60);
                
                console.log("Current ads:", todayAds, "Hours diff:", hoursDiff);
                
                // Reset if 1 hour has passed since last reset
                if (hoursDiff >= 1) {
                    todayAds = 0;
                    lastAdReset = now.toISOString();
                    console.log("Resetting counter due to time passed");
                }
                
                // Check if user has reached limit (now 20)
                if (todayAds >= 20) {
                    alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶° ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡ßß ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                    resetAdButton();
                    isAdLoading = false;
                    return;
                }
                
                // Add reward and update ads count
                const newAdCount = todayAds + 1;
                console.log("Updating ads count to:", newAdCount);
                
                await updateUserData({ 
                    balance: currentUser.balance + 30,
                    total_income: (currentUser.total_income || 0) + 30,
                    today_ads: newAdCount,
                    last_ad_reset: lastAdReset
                });
                
                // Update local data
                userAdsData.today_ads = newAdCount;
                userAdsData.last_ad_reset = lastAdReset;
                
                // Update UI
                updateCounter();
                updateResetTimer();
                
                // Success message
                document.getElementById('rewardStatus').textContent = '‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!';
                document.getElementById('rewardStatus').className = 'text-sm text-green-600 font-semibold';
                
                const watchBtn = document.getElementById('watchAdBtn');
                watchBtn.innerHTML = '<i class="fas fa-check mr-2"></i>‡¶∏‡¶´‡¶≤! ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá';
                watchBtn.classList.remove('ad-loading', 'bg-gradient-to-r', 'from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                watchBtn.classList.add('bg-green-500');
                
                showNotification('üéâ ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®! ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§\n‡¶è‡¶° ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶®‡¶ø‡¶ú‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    if (canWatchMoreAds()) {
                        resetAdButton();
                    }
                    isAdLoading = false;
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error rewarding user for ad:', error);
                document.getElementById('adStatus').textContent = '‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
                document.getElementById('adStatus').className = 'text-xs text-red-600';
                throw error;
            }
        }

        function resetAdButton() {
            if (canWatchMoreAds()) {
                const watchBtn = document.getElementById('watchAdBtn');
                watchBtn.innerHTML = '<i class="fas fa-play mr-2"></i>‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                watchBtn.classList.remove('bg-green-500', 'ad-loading');
                watchBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
                watchBtn.disabled = false;
                document.getElementById('adStatus').textContent = '‡¶è‡¶° ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§';
                document.getElementById('adStatus').className = 'text-xs text-green-600';
                document.getElementById('rewardStatus').textContent = '‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá';
                document.getElementById('rewardStatus').className = 'text-gray-500 text-sm';
            }
        }

        function showNotification(message, type = 'info') {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.showPopup({
                    title: type === 'success' ? '‡¶∏‡¶´‡¶≤!' : '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú',
                    message: message,
                    buttons: [{ type: 'close' }]
                });
            } else {
                alert(message);
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Update reset timer every 30 seconds
        setInterval(updateResetTimer, 30000);
        
        // Check for reset every minute
        setInterval(() => {
            const user = getUserData();
            if (user) {
                checkAndResetAdsCounter(user);
            }
        }, 60000);

        document.addEventListener('DOMContentLoaded', function() {
            // Check if supabase is loaded
            if (typeof getUserData === 'function') {
                setTimeout(initAdsPage, 1000);
            } else {
                console.error("Supabase functions not loaded");
                document.getElementById('loadingOverlay').style.display = 'none';
                alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
        });
    </script>
</body>
</html>