<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সহজ ইনকাম - সাপোর্ট</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body {
            padding-bottom: 70px;
        }
        .payment-method.active {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">লোড হচ্ছে...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 fade-in">
        <!-- হেডার -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-4 text-white mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-lg">সাপোর্ট & উইথড্র</h2>
                    <p class="text-white/80 text-sm">টাকা উত্তোলন করুন</p>
                </div>
                <i class="fas fa-headset text-2xl"></i>
            </div>
        </div>

        <!-- ব্যালেন্স কার্ড -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-gray-500 text-sm">মেইন ব্যালেন্স</p>
                    <h1 class="text-2xl font-bold text-green-600" id="withdrawBalance">০.০০ টাকা</h1>
                </div>
                <i class="fas fa-wallet text-2xl text-green-500"></i>
            </div>
        </div>

        <!-- উইথড্র ফর্ম -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
            <h3 class="font-bold text-lg mb-4">টাকা উত্তোলন করুন</h3>
            
            <!-- পেমেন্ট মেথড -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2">পেমেন্ট মেথড</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectMethod('bkash')" id="bkashBtn" class="border-2 border-blue-500 bg-blue-50 rounded-lg p-3 text-center payment-method active hover:bg-blue-100 transition-colors">
                        <i class="fas fa-mobile-alt text-blue-500 text-xl mb-1"></i>
                        <p class="font-semibold text-blue-700">bKash</p>
                    </button>
                    <button onclick="selectMethod('nagad')" id="nagadBtn" class="border border-gray-300 rounded-lg p-3 text-center payment-method hover:bg-gray-50 transition-colors">
                        <i class="fas fa-wallet text-green-500 text-xl mb-1"></i>
                        <p class="font-semibold text-gray-700">Nagad</p>
                    </button>
                    <button onclick="selectMethod('usdt')" id="usdtBtn" class="border border-gray-300 rounded-lg p-3 text-center payment-method hover:bg-gray-50 transition-colors">
                        <i class="fab fa-usd text-yellow-500 text-xl mb-1"></i>
                        <p class="font-semibold text-gray-700">USDT</p>
                    </button>
                </div>
            </div>
            
            <!-- অ্যামাউন্ট -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2">অ্যামাউন্ট (টাকায়)</label>
                <input type="number" placeholder="500" id="withdrawAmount" min="500"
                    class="w-full border border-gray-300 rounded-lg p-3 text-lg font-semibold focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-colors"
                    oninput="updateUSDTAmount()">
                <p class="text-gray-500 text-xs mt-1">ন্যূনতম উত্তোলন: ৫০০ টাকা</p>
                <!-- USDT কনভার্সন ডিসপ্লে -->
                <div id="usdtConversion" class="hidden mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm font-semibold text-yellow-700" id="usdtAmountDisplay">0.00 USDT</p>
                </div>
            </div>
            
            <!-- অ্যাকাউন্ট নম্বর -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2" id="accountLabel">আপনার bKash নম্বর</label>
                <input type="text" placeholder="01XXXXXXXXX" id="accountNumber"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-colors">
            </div>

            <!-- USDT নেটওয়ার্ক সিলেক্ট -->
            <div id="usdtNetworkSection" class="mb-4 hidden">
                <label class="block text-gray-700 text-sm font-semibold mb-2">USDT নেটওয়ার্ক সিলেক্ট করুন</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectUSDTNetwork('trc')" id="trcBtn" class="border border-gray-300 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                        <p class="font-semibold text-gray-700">TRC20</p>
                        <p class="text-xs text-gray-500">ফি কম</p>
                    </button>
                    <button onclick="selectUSDTNetwork('erc')" id="ercBtn" class="border border-gray-300 rounded-lg p-3 text-center hover:bg-gray-50 transition-colors">
                        <p class="font-semibold text-gray-700">ERC20</p>
                        <p class="text-xs text-gray-500">সাধারণ</p>
                    </button>
                </div>
                <p class="text-gray-500 text-xs mt-2">আপনার USDT ওয়ালেট ঠিকানা উপরে ইনপুট করুন</p>
            </div>
            
            <button onclick="submitWithdraw()" id="withdrawBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-green-700 transition-colors">
                উইথড্র রিকোয়েস্ট করুন
            </button>
        </div>

        <!-- রেফারেল সেকশন -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-4 text-white">
            <h3 class="font-bold text-lg mb-2">বন্ধুকে রেফার করুন</h3>
            <p class="text-white/90 text-sm mb-3">প্রতি রেফারেলে পাবেন ১০০ টাকা</p>
            
            <div class="bg-white/10 rounded-lg p-3 mb-3">
                <p class="text-xs mb-1">আপনার রেফারেল লিঙ্ক</p>
                <div class="flex items-center justify-between">
                    <code class="text-sm font-mono break-all" id="supportReferralLink">লোড হচ্ছে...</code>
                    <button onclick="copySupportReferral()" class="bg-white text-purple-600 px-3 py-1 rounded text-sm font-semibold hover:bg-gray-100 transition-colors">
                        কপি
                    </button>
                </div>
            </div>
            
            <div class="bg-white/10 rounded-lg p-3">
                <p class="text-sm mb-1">উইথড্র এর শর্ত</p>
                <p class="text-white/80 text-xs">• ন্যূনতম ৫০০ টাকা উত্তোলন করতে হবে</p>
                <p class="text-white/80 text-xs">• ন্যূনতম ১৫টি রেফারেল প্রয়োজন</p>
                <p class="text-white/80 text-xs">• ন্যূনতম ১০টি এড দেখতে হবে</p>
            </div>
        </div>

        <!-- সাপোর্ট তথ্য -->
        <div class="bg-white rounded-xl p-4 shadow-sm mt-4">
            <h3 class="font-bold text-lg mb-3">সাপোর্ট</h3>
            <div class="space-y-2">
                <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fab fa-telegram text-blue-400 mr-3"></i>
                    <div>
                        <p class="font-semibold">টেলিগ্রাম সাপোর্ট</p>
                        <p class="text-gray-600 text-sm">@sohojincome_support</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- বটম নেভিগেশন -->
    <div class="bottom-nav">
        <div class="grid grid-cols-4 gap-1 p-2">
            <a href="index.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-home mb-1"></i>
                <span class="text-xs">হোম</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-tasks mb-1"></i>
                <span class="text-xs">টাস্ক</span>
            </a>
            <a href="support.html" class="flex flex-col items-center p-2 text-blue-600">
                <i class="fas fa-headset mb-1"></i>
                <span class="text-xs">সাপোর্ট</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center p-2 text-gray-500">
                <i class="fas fa-user mb-1"></i>
                <span class="text-xs">প্রোফাইল</span>
            </a>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app-supabase.js"></script>

    <script>
        let selectedMethod = 'bkash';
        let selectedUSDTNetwork = 'trc';
        const USDT_RATE = 120; // 1 USDT = 120 টাকা

        function initSupportPage() {
            const user = getUserData();
            if (user) {
                document.getElementById('withdrawBalance').textContent = user.balance.toFixed(2) + ' টাকা';
                document.getElementById('supportReferralLink').textContent = generateReferralLink();
            }
            hideLoading();
        }

        function selectMethod(method) {
            selectedMethod = method;
            
            // সব বাটনের active class remove করুন
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.classList.remove('active', 'border-2', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('border', 'border-gray-300');
            });
            
            // selected বাটনে active class add করুন
            const selectedBtn = document.getElementById(method + 'Btn');
            selectedBtn.classList.add('active', 'border-2', 'border-blue-500', 'bg-blue-50');
            selectedBtn.classList.remove('border', 'border-gray-300');
            
            // Label এবং প্লেসহোল্ডার update করুন
            const methodNames = {
                'bkash': 'bKash',
                'nagad': 'Nagad', 
                'usdt': 'USDT'
            };

            const placeholders = {
                'bkash': '01XXXXXXXXX',
                'nagad': '01XXXXXXXXX',
                'usdt': 'Txyz... বা 0xabc... (USDT ওয়ালেট ঠিকানা)'
            };

            document.getElementById('accountLabel').textContent = 'আপনার ' + methodNames[method] + (method === 'usdt' ? ' ওয়ালেট ঠিকানা' : ' নম্বর');
            document.getElementById('accountNumber').placeholder = placeholders[method];

            // USDT এর ক্ষেত্রে বিশেষ সেকশন দেখান
            const usdtNetworkSection = document.getElementById('usdtNetworkSection');
            const usdtConversion = document.getElementById('usdtConversion');
            
            if (method === 'usdt') {
                usdtNetworkSection.classList.remove('hidden');
                usdtConversion.classList.remove('hidden');
                // ডিফল্ট হিসেবে TRC20 সিলেক্ট করুন
                selectUSDTNetwork('trc');
                // USDT কনভার্সন আপডেট করুন
                updateUSDTAmount();
            } else {
                usdtNetworkSection.classList.add('hidden');
                usdtConversion.classList.add('hidden');
            }
        }

        function selectUSDTNetwork(network) {
            selectedUSDTNetwork = network;
            
            // সব USDT নেটওয়ার্ক বাটন রিসেট
            document.getElementById('trcBtn').classList.remove('border-blue-500', 'border-2', 'bg-blue-50');
            document.getElementById('trcBtn').classList.add('border-gray-300');
            document.getElementById('ercBtn').classList.remove('border-blue-500', 'border-2', 'bg-blue-50');
            document.getElementById('ercBtn').classList.add('border-gray-300');
            
            // সিলেক্টেড বাটন হাইলাইট
            const selectedBtn = document.getElementById(network + 'Btn');
            selectedBtn.classList.add('border-blue-500', 'border-2', 'bg-blue-50');
            selectedBtn.classList.remove('border-gray-300');
        }

        function updateUSDTAmount() {
            if (selectedMethod !== 'usdt') return;
            
            const amountInput = document.getElementById('withdrawAmount');
            const amount = parseFloat(amountInput.value) || 0;
            
            if (amount > 0) {
                const usdtAmount = amount / USDT_RATE;
                document.getElementById('usdtAmountDisplay').textContent = usdtAmount.toFixed(4) + ' USDT';
                document.getElementById('usdtConversion').classList.remove('hidden');
            } else {
                document.getElementById('usdtConversion').classList.add('hidden');
            }
        }

        function copySupportReferral() {
            const refLink = document.getElementById('supportReferralLink').textContent;
            
            try {
                navigator.clipboard.writeText(refLink);
                showNotification('রেফারেল লিঙ্ক কপি করা হয়েছে!', 'success');
            } catch (error) {
                // Fallback
                const tempInput = document.createElement('input');
                tempInput.value = refLink;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showNotification('রেফারেল লিঙ্ক কপি করা হয়েছে!', 'success');
            }
        }

        async function submitWithdraw() {
            const user = getUserData();
            if (!user) {
                alert('ডেটা লোড হয়নি। রিফ্রেশ করুন।');
                return;
            }

            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const accountNumber = document.getElementById('accountNumber').value;

            // Check minimum amount
            if (!amount || amount < 500) {
                showNotification('ন্যূনতম ৫০০ টাকা উত্তোলন করতে হবে!', 'error');
                return;
            }

            // Check account number/wallet address based on method
            if (selectedMethod === 'usdt') {
                // USDT ওয়ালেট ঠিকানা ভ্যালিডেশন
                if (!accountNumber || accountNumber.trim() === '') {
                    showNotification('USDT ওয়ালেট ঠিকানা দিন!', 'error');
                    return;
                }
                // ওয়ালেট ঠিকানার সাধারণ চেক
                if (accountNumber.length < 20) {
                    showNotification('সঠিক USDT ওয়ালেট ঠিকানা দিন!', 'error');
                    return;
                }
            } else {
                // bKash/Nagad মোবাইল নম্বর ভ্যালিডেশন
                if (!accountNumber || accountNumber.length !== 11 || !accountNumber.startsWith('01')) {
                    showNotification('সঠিক মোবাইল নম্বর দিন (11 ডিজিট, 01 দিয়ে শুরু)!', 'error');
                    return;
                }
            }

            // Check balance
            if (amount > user.balance) {
                showNotification(`আপনার ব্যালেন্স insufficient!\nআপনার ব্যালেন্স: ${user.balance.toFixed(2)} টাকা`, 'error');
                return;
            }

            // Check referral requirement
            if (user.total_referrals < 15) {
                showNotification(
                    `রেফারেল প্রয়োজন!\n\nআপনার রেফারেল: ${user.total_referrals} জন\nপ্রয়োজন: ১৫ জন\n\nআরও ${15 - user.total_referrals} জন রেফারেল প্রয়োজন।`,
                    'error'
                );
                return;
            }

            // Check AD requirement
            if (user.total_ads < 10) {
                showNotification(
                    `এড দেখার প্রয়োজন!\n\nআপনার দেখা এড: ${user.total_ads} টি\nপ্রয়োজন: ১০ টি\n\nআরও ${10 - user.total_ads} টি এড দেখুন।`,
                    'error'
                );
                return;
            }

            // All checks passed - Process withdraw
            await processWithdrawRequestSupabase(amount, accountNumber);
        }

        async function processWithdrawRequestSupabase(amount, accountNumber) {
            const user = getUserData();
            
            try {
                // Show loading
                const withdrawBtn = document.getElementById('withdrawBtn');
                withdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>প্রসেস হচ্ছে...';
                withdrawBtn.disabled = true;

                // USDT হলে কনভার্সন ইনফো যোগ করুন
                let withdrawDetails = {
                    amount: amount,
                    account: accountNumber,
                    method: selectedMethod
                };

                if (selectedMethod === 'usdt') {
                    const usdtAmount = amount / USDT_RATE;
                    withdrawDetails.usdt_amount = usdtAmount.toFixed(4);
                    withdrawDetails.usdt_network = selectedUSDTNetwork;
                    withdrawDetails.usdt_rate = USDT_RATE;
                }

                // Deduct balance from user
                await updateUserData({
                    balance: user.balance - amount
                });

                // Save withdraw request to Supabase
                await saveWithdrawToSupabase(withdrawDetails);

                // Success message
                let successMessage = `✅ উইথড্র রিকোয়েস্ট সফল!\n\nপরিমাণ: ${amount} টাকা\n`;

                if (selectedMethod === 'usdt') {
                    const usdtAmount = amount / USDT_RATE;
                    successMessage += `USDT: ${usdtAmount.toFixed(4)} (${selectedUSDTNetwork.toUpperCase()})\n`;
                    successMessage += `ওয়ালেট: ${accountNumber}\n`;
                } else {
                    successMessage += `${getMethodName(selectedMethod)}: ${accountNumber}\n`;
                }

                successMessage += `\n২৪ ঘন্টার মধ্যে পেমেন্ট করা হবে।`;

                showNotification(successMessage, 'success');

                // Reset form
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('accountNumber').value = '';
                document.getElementById('usdtConversion').classList.add('hidden');
                
                // Update balance display
                document.getElementById('withdrawBalance').textContent = (user.balance - amount).toFixed(2) + ' টাকা';

            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('উইথড্র রিকোয়েস্ট ব্যর্থ! আবার চেষ্টা করুন।', 'error');
            } finally {
                // Reset button
                withdrawBtn.innerHTML = 'উইথড্র রিকোয়েস্ট করুন';
                withdrawBtn.disabled = false;
            }
        }

        function getMethodName(method) {
            const methodNames = {
                'bkash': 'bKash',
                'nagad': 'Nagad',
                'usdt': 'USDT'
            };
            return methodNames[method] || method;
        }

        function showNotification(message, type = 'info') {
            const title = type === 'success' ? 'সফল!' : 
                         type === 'error' ? 'ত্রুটি!' : 'মেসেজ';
            
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.showPopup({
                    title: title,
                    message: message,
                    buttons: [{ type: 'close' }]
                });
            } else {
                alert(message);
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initSupportPage, 1000);
        });
    </script>
</body>
</html>
